# Summary of raw data

## Sample size of `r project` data set:  

```{r sample_size, echo=FALSE, results = 'asis'}
layer_names = dimnames(metaboprep@data)[[3]]
excl_samps = unique( unlist(metaboprep@exclusions$samples ))
incl_samps = setdiff(rownames(metaboprep@data[, ,layer_names[2]]), excl_samps)
excl_feats = unique( unlist(metaboprep@exclusions$features ))
incl_feats = setdiff(colnames(metaboprep@data[, ,layer_names[2]]), excl_feats)

sample_size_table <- data.frame(
  Dataset  = toupper(gsub("_"," ",layer_names)),
  Samples  = c( nrow(metaboprep@data[ , ,layer_names[1]]) , length(incl_samps) ),
  Features = c( ncol(metaboprep@data[ , ,layer_names[1]]) ,  length(incl_feats) ),
  stringsAsFactors = FALSE
)

# extract
# sample_size_table <- do.call(rbind, lapply(dimnames(metaboprep@data)[[3]], function(layer_name) {
#   
#   incl_samps <- setdiff(rownames(metaboprep@data[, , layer_name]), unlist(metaboprep@exclusions[["samples"]]))
#   incl_feats <- setdiff(colnames(metaboprep@data[, , layer_name]), unlist(metaboprep@exclusions[["features"]]))
#   data <- metaboprep@data[incl_samps, incl_feats, layer_name]
#   
#   data.frame(
#     `Dataset`  = toupper(gsub("_"," ",layer_name)), 
#     `Samples`  = nrow(data), 
#     `Features` = ncol(data),
#     stringsAsFactors = FALSE
#   ) 
#   
# }))

# table
sample_size_table |>
  knitr::kable(
    caption = "Sample Size Summary"
  ) |>
  kableExtra::kable_classic(
    lightable_options = "hover",
    html_font         = report_font,
    latex_options     = c("hold_position")) |>
  kableExtra::column_spec(
    column = 1, 
    width  = "25em"
  )

```

\newpage

# Missingness
Missingness is evaluated across samples and features using the original (input) data set. 

## Visual structure of missingness in the raw data
```{r missing_matrix, fig.width=10, fig.height=6}
# raw data
namat <- metaboprep@data[, , "input"]
namat[!is.na(namat)] <- 1 
namat[is.na(namat)] <- 0
nadat <- as.data.frame(namat)
nadat$samples <- rownames(nadat)
nadat <- as.data.frame(nadat)
nadat_long <- reshape2::melt(nadat, id.vars = "samples", variable.name = "features", value.name = "missing")
nadat_long$missing  <- factor(nadat_long$missing, levels = c(0, 1), labels = c("Missing", "Present"))
nadat_long$samples  <- factor(nadat_long$samples,  levels = rownames(namat))
nadat_long$features <- factor(nadat_long$features, levels = colnames(namat))
             
# plot
ggplot(nadat_long, aes(x = features, y = samples, fill = missing)) + 
  geom_tile() + 
  scale_fill_manual(
    values = c("Missing" = "red", "Present" = "grey95")
  ) +
  theme(
    text            = element_text(family = "Helvetica"),
    legend.position = "bottom",  
    axis.text.x     = element_blank(),
    axis.text.y     = element_blank(),
    axis.ticks      = element_blank()
  ) +
  labs(
    x = "Features",  
    y = "Samples",  
    fill = "Missingness"  
  )
```

\newpage

## Summary of sample and feature missingness
The extent of missing data in both samples and features of the dataset was evaluated - for each sample, the proportion of features with missing values, and for each feature, the proportion of samples with missing values. This can identify whether missingness is more strongly driven by poorly measured features or by problematic samples. 

The distribution of missingness is summarized in:  

1. histograms  
2. tabulated using percentiles, and  
3. estimates of sample and feature samples sizes under various levels of missingness filtering thresholds


```{r missing_summary_compute}
# raw data
data <- metaboprep@data[, , "input"]

# calculate missingness
missing <- rbind(
  data.frame("type"        = "Samples", 
             "missingness" = apply(data, 1, function(x){ sum(is.na(x))/length(x)  })),
  data.frame("type"        = "Features",
             "missingness" = apply(data, 2, function(x){ sum(is.na(x))/length(x)  }))
)

# quantile distribution of missingness table
probs         <- seq(0, 1, 0.25)
split_list    <- split(missing$missingness, missing$type)
quantile_list <- lapply(split_list, function(x) quantile(x, probs = probs))
tbl1          <- do.call(cbind, quantile_list)
tbl1          <- data.frame(percentile = probs, tbl1, check.names = FALSE)

tbl1 <- tbl1 |>
  knitr::kable(
    caption   = "Sample and feature missingness percentiles.",
    col.names = c("Percentile", "Features", "Samples"),
    digits    = 3,
    align     = rep("c", 3)
  ) |>
  kableExtra::kable_classic(
    lightable_options = "hover",
    html_font         = report_font,
    full_width        = FALSE,
    latex_options     = c("hold_position")
  ) |> 
  kableExtra::column_spec(
    column = 1:3, 
    width  = "7em"
  )

# Estimates of sample size given various levels of missingness
# miss_thresholds <- expand.grid(fmiss_thresh = seq(0.0, 1.0, 0.1), 
#                                smiss_thresh = seq(0.0, 1.0, 0.1))
# miss_thresholds[["Feature missingness threshold"]] <- scales::percent(miss_thresholds[["fmiss_thresh"]], accuracy = 1)
# miss_thresholds[["Sample missingness threshold"]]  <- scales::percent(miss_thresholds[["smiss_thresh"]], accuracy = 1)
# miss_thresholds[["Feature missingness threshold"]] <- factor(miss_thresholds[["Feature missingness threshold"]], levels = unique(miss_thresholds[["Feature missingness threshold"]]))
# miss_thresholds[["Sample missingness threshold"]]  <- factor(miss_thresholds[["Sample missingness threshold"]], levels = unique(miss_thresholds[["Sample missingness threshold"]]))
# miss_thresholds[["Sample size"]] <- mapply(function(f_thresh, s_thresh) {
#   filtered_data <- data
#   bad_features  <- which(colMeans(is.na(filtered_data)) >= f_thresh)
#   bad_samples   <- which(rowMeans(is.na(filtered_data)) >= s_thresh)
#   if (length(bad_features) > 0 & length(bad_samples) > 0) {
#     filtered_data <- filtered_data[-bad_samples, -bad_features, drop = FALSE]
#   } else if (length(bad_samples) > 0) {
#     filtered_data <- filtered_data[-bad_samples, , drop = FALSE]
#   } else if (length(bad_features) > 0) {
#     filtered_data <- filtered_data[, -bad_features, drop = FALSE]
#   }
#   sum(rowSums(!is.na(filtered_data)) > 0)
# }, 
# f_thresh = miss_thresholds$fmiss_thresh,
# s_thresh = miss_thresholds$smiss_thresh)
# 
## Number of samples at various sample missingness thresholds
thresholds = seq(0.05, 1, by = 0.05)
missing_sample_sizes <- sapply(thresholds, function(thresh) {
  length(split_list$Samples) - sum(split_list$Samples >= thresh)
})

missing_feature_sizes <- sapply(thresholds, function(thresh) {
  length(split_list$Features) - sum(split_list$Features >= thresh)
})

tbl2sf = data.frame(
  `Missingness threshold` = scales::percent(thresholds, accuracy = 1),
  `Number of Samples`     = missing_sample_sizes,
  `Number of Features`    = missing_feature_sizes
  ) |>
  knitr::kable(
    caption = "Estimates of sample and feature sample sizes at different missingness thresholds.",
    align   = rep("c", 2),
    row.names  = FALSE
  ) |>
  kableExtra::kable_classic(
    lightable_options = "hover",
    html_font         = report_font,
    latex_options     = c("hold_position")
  ) |>
  kableExtra::column_spec(
    column = 1:2,
    width  = "15em"
  )


# # feature missingness threshold table
# tbl2f <- miss_thresholds[miss_thresholds$smiss_thresh==1.0 & miss_thresholds$fmiss_thresh %in% seq(0, 1, 0.2),
#                         c("Feature missingness threshold", "Sample size")] |>
#   knitr::kable(
#     caption = "Estimates of samples sizes using different feature missingness thresholds.",
#     align   = rep("c", 2),
#     row.names  = FALSE
#   ) |>
#   kableExtra::kable_classic(
#     lightable_options = "hover",
#     html_font         = report_font,
#     latex_options     = c("hold_position")
#   ) |>
#   kableExtra::column_spec(
#     column = 1:2,
#     width  = "15em"
#   )

# # sample missingness threshold table
# tbl2s <- miss_thresholds[miss_thresholds$fmiss_thresh==1.0 & miss_thresholds$smiss_thresh %in% seq(0, 1, 0.2), 
#                         c("Sample missingness threshold", "Sample size")] |>
#   knitr::kable(
#     caption = "Estimates of samples sizes using different sample missingness thresholds.",
#     align   = rep("c", 2), 
#     row.names  = FALSE
#   ) |>
#   kableExtra::kable_classic(
#     lightable_options = "hover",
#     html_font         = report_font,
#     latex_options     = c("hold_position")
#   ) |>
#   kableExtra::column_spec(
#     column = 1:2, 
#     width  = "15em"
#   )

# sample size by thresholds
# miss_thresh_sample_size_heatmap <- ggplot(
#   miss_thresholds,
#   aes(
#     x = `Feature missingness threshold`,
#     y = `Sample missingness threshold`,
#     fill = `Sample size`
#   )
# ) +
#   geom_tile(color = "white") +
#   scale_fill_gradient(
#     low = "firebrick",
#     high = "steelblue",
#     name = "Sample size"
#   ) +
#   labs(
#     x = "Feature missingness threshold",
#     y = "Sample missingness threshold"
#   ) +
#   theme_minimal() +
#   coord_fixed() +
#   theme(
#     axis.text.x  = element_text(angle = 45, hjust = 1),
#     panel.grid   = element_blank(), 
#     legend.position = "top"
#   )

# missing histograms
medians <- tapply(missing$missingness, missing$type, median)
medians_df <- data.frame(type = names(medians), median = as.vector(medians))
miss_hists <- ggplot(missing, aes(x = missingness, color=type, fill=type)) +
  geom_histogram(aes(y = ..density..), fill="white", bins = 25) +
  geom_density(alpha = 0.4) +
  geom_vline(data = medians_df,
             aes(xintercept = median), color = "darkred", linewidth = 0.75, linetype="dashed") +
  scale_color_manual(values = c(Samples = "darkblue", Features = "orange")) +
  scale_fill_manual(values = c(Samples = "lightblue", Features = "lightyellow")) +
  scale_x_continuous(labels = scales::percent) +
  theme_classic() +
  guides(fill="none", color="none") +
  labs(
    x       = "Missingness", 
    y       = "Density",
    caption = "red vertical line = median") +
  theme(
    text             = element_text(family = report_font),
    panel.grid       = element_blank(), 
    strip.background = element_blank(),
    strip.text       = element_text(size=12)
  ) +
  facet_wrap(~type, scales = "free")
```

```{r histograms, fig.width=14, fig.height=4}
miss_hists
```

\newpage

<!-- Table of sample and feature missingness percentiles. A tabled version of the histogram plots. -->
```{r percentiles}
tbl1
```

<!-- Estimates of study samples sizes under various levels of feature missingness. -->

```{r miss_sample_sizes}
# tbl2f
# tbl2s
tbl2sf
# miss_thresh_sample_size_heatmap
```
