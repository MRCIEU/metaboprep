# Summary of raw data

## Sample size of `r project` data set:  

```{r sample_size, echo=FALSE, results = 'asis'}
# extract
sample_size_table <- do.call(rbind, lapply(dimnames(metaboprep@data)[[3]], function(layer_name) {
  
  incl_samps <- setdiff(rownames(metaboprep@data[, , layer_name]), unlist(metaboprep@exclusions[["samples"]]))
  incl_feats <- setdiff(colnames(metaboprep@data[, , layer_name]), unlist(metaboprep@exclusions[["features"]]))
  data <- metaboprep@data[incl_samps, incl_feats, layer_name]
  
  data.frame(
    `Dataset`  = toupper(gsub("_"," ",layer_name)), 
    `Samples`  = nrow(data), 
    `Features` = ncol(data),
    stringsAsFactors = FALSE
  ) 
  
}))

# table
sample_size_table |>
  knitr::kable(
    caption = "Sample Size Summary"
  ) |>
  kableExtra::kable_classic(
    lightable_options = "hover",
    html_font         = report_font,
    latex_options     = c("hold_position")) |>
  kableExtra::column_spec(
    column = 1, 
    width  = "25em"
  )

```

\newpage

# Missingness
Missingness is evaluated across samples and features using the original (input) data set. 

## Visual structure of missingness in the raw data
```{r missing_matrix}
# raw data
namat <- metaboprep@data[, , "input"]
namat[!is.na(namat)] <- 1 
namat[is.na(namat)] <- 0
nadat <- as.data.frame(namat)
nadat$samples <- rownames(nadat)
nadat <- as.data.frame(nadat)
nadat_long <- reshape2::melt(nadat, id.vars = "samples", variable.name = "features", value.name = "missing")
nadat_long$missing  <- factor(nadat_long$missing, levels = c(0, 1), labels = c("Missing", "Present"))
nadat_long$samples  <- factor(nadat_long$samples,  levels = rownames(namat))
nadat_long$features <- factor(nadat_long$features, levels = colnames(namat))
             
# plot
ggplot(nadat_long, aes(x = features, y = samples, fill = missing)) + 
  geom_tile() + 
  scale_fill_manual(
    values = c("Missing" = "red", "Present" = "white")
  ) +
  theme(
    text            = element_text(family = "Helvetica"),
    legend.position = "bottom",  
    axis.text.x     = element_blank(),
    axis.text.y     = element_blank(),
    axis.ticks      = element_blank()
  ) +
  labs(
    x = "Features",  
    y = "Samples",  
    fill = "Missingness"  
  )
```

\newpage

## Summary of sample and feature missingness
The extent of missing data in both samples and features of the dataset was evaluated - for each sample, the proportion of features with missing values, and for each feature, the proportion of samples with missing values. This can identify whether missingness is more strongly driven by poorly measured features or by problematic samples. 

The distribution of missingness is summarized in:  

1. histograms  
2. tabulated using percentiles, and  
3. estimates of study samples sizes under various levels of feature missingness - this helps in understanding how filtering features with high levels of missing data would affect the dataset.


```{r missing_summary_compute}
# raw data
data <- metaboprep@data[, , "input"]

# calculate missingness
missing <- rbind(
  data.frame("type"        = "Samples", 
             "missingness" = apply(data, 1, function(x){ sum(is.na(x))/length(x)  })),
  data.frame("type"        = "Features",
             "missingness" = apply(data, 2, function(x){ sum(is.na(x))/length(x)  }))
)

# quantile distribution of missingness table
probs         <- seq(0, 1, 0.25)
split_list    <- split(missing$missingness, missing$type)
quantile_list <- lapply(split_list, function(x) quantile(x, probs = probs))
tbl1          <- do.call(cbind, quantile_list)
tbl1          <- data.frame(percentile = probs, tbl1, check.names = FALSE)

tbl1 <- tbl1 |>
  knitr::kable(
    caption   = "Sample and feature missingness percentiles.",
    col.names = c("Percentile", "Features", "Samples"),
    digits    = 3,
    align     = rep("c", 3)
  ) |>
  kableExtra::kable_classic(
    lightable_options = "hover",
    html_font         = report_font,
    full_width        = FALSE,
    latex_options     = c("hold_position")
  ) |> 
  kableExtra::column_spec(
    column = 1:3, 
    width  = "7em"
  )

# Estimates of sample size given various levels of missingness
sq <- seq(0.0, 1.0, 0.01)
fmiss_samplesize <- data.frame(
  `Missingness` = scales::percent(sq, accuracy = 1),
  `Sample Size` = sapply(sq, function(threshold) {
    kept_features <- which(colMeans(is.na(data)) <= threshold)
    filtered_data <- data[, kept_features, drop = FALSE]
    sum(rowSums(!is.na(filtered_data)) > 0)
  })
)

# tables together
tbl2 <- fmiss_samplesize |>
  knitr::kable(
    caption = "Estimates of samples sizes using different feature missingness thresholds.",
    align   = rep("c", 2)
  ) |>
  kableExtra::kable_classic(
    lightable_options = "hover",
    html_font         = report_font,
    latex_options     = c("hold_position")
  ) |>
  kableExtra::column_spec(
    column = 1:2, 
    width  = "15em"
  )

# missing histograms
medians <- tapply(missing$missingness, missing$type, median)
medians_df <- data.frame(type = names(medians), median = as.vector(medians))
miss_hists <- ggplot(missing, aes(x = missingness, color=type, fill=type)) +
  geom_histogram(aes(y = ..density..), fill="white", bins = 25) +
  geom_density(alpha = 0.4) +
  geom_vline(data = medians_df,
             aes(xintercept = median), color = "darkred", linewidth = 0.75, linetype="dashed") +
  scale_color_manual(values = c(Samples = "darkblue", Features = "orange")) +
  scale_fill_manual(values = c(Samples = "lightblue", Features = "lightyellow")) +
  scale_x_continuous(labels = scales::percent) +
  theme_classic() +
  guides(fill="none", color="none") +
  labs(
    x       = "Missingness", 
    y       = "Density",
    caption = "red vertical line = median") +
  theme(
    text             = element_text(family = report_font),
    panel.grid       = element_blank(), 
    strip.background = element_blank(),
    strip.text       = element_text(size=12)
  ) +
  facet_wrap(~type, scales = "free")
```

```{r histograms}
miss_hists
```

<!-- Table of sample and feature missingness percentiles. A tabled version of the histogram plots. -->
```{r percentiles}
tbl1
```

<!-- Estimates of study samples sizes under various levels of feature missingness. -->

```{r miss_sample_sizes}
tbl2
```
