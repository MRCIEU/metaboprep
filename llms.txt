# metaboprep

The goal of `metaboprep` is to:

1.  Read in and processes (un)targeted metabolite data, saving datasets
    in tab-delimited format for use elsewhere
2.  Provide useful summary data in the form of tab-delimited text file
    and a html report.  
3.  Perform data filtering on the data set using a standard pipeline and
    according to user-defined thresholds.

## Installation

You can install the development version of metaboprep from
[GitHub](https://github.com/MRCIEU/metaboprep/tree/v2_development) with:

``` r
# install.packages("pak")
pak::pak("MRCIEU/metaboprep")
```

## Cheatsheet

![Cheatsheet](reference/figures/cheatsheet.png)

Cheatsheet

## Example

This is a basic example which shows you how to load data and run the
`metaboprep` quality control pipeline.

### Read data into R and create the Metaboprep object

``` r
library(metaboprep)

# import data 
mydata <- read_metabolon(system.file("extdata", "metabolon_v1.1_example.xlsx", package = "metaboprep"), 
                         sheet             = "OrigScale", ## The name of the sheet in the excel file to read in
                         return_Metaboprep = FALSE        ## Whether to return a Metaboprep object (TRUE) or a list (FALSE)
                         )

# create metaboprep object
mydata <- Metaboprep(data     = mydata$data, 
                     features = mydata$features, 
                     samples  = mydata$samples)
```

### Run the quality control pipeline

``` r
# run QC
mydata <- mydata |> quality_control( source_layer        = "input", 
                                     sample_missingness  = 0.2, 
                                     feature_missingness = 0.2, 
                                     total_peak_area_sd  = 5, 
                                     outlier_udist       = 5, 
                                     outlier_treatment   = "leave_be", 
                                     winsorize_quantile  = 1.0, 
                                     tree_cut_height     = 0.5, 
                                     pc_outlier_sd       = 5, 
                                     sample_ids          = NULL, 
                                     feature_ids         = NULL)
#> 
#> ── Starting Metabolite QC Process ──────────────────────────────────────────────
#> ℹ Validating input parameters✔ Validating input parameters [4ms]
#> ℹ Sample & Feature Summary Statistics for raw data✔ Sample & Feature Summary Statistics for raw data [540ms]
#> ℹ Copying input data to new 'qc' data layer✔ Copying input data to new 'qc' data layer [10ms]
#> ℹ Assessing for extreme sample missingness >=80% - excluding 0 sample(s)✔ Assessing for extreme sample missingness >=80% - excluding 0 sample(s) [7ms]
#> ℹ Assessing for extreme feature missingness >=80% - excluding 0 feature(s)✔ Assessing for extreme feature missingness >=80% - excluding 0 feature(s) [7ms]
#> ℹ Assessing for sample missingness at specified level of >=20% - excluding 0 sa…✔ Assessing for sample missingness at specified level of >=20% - excluding 2 sa…
#> ℹ Assessing for feature missingness at specified level of >=20% - excluding 0 f…✔ Assessing for feature missingness at specified level of >=20% - excluding 0 f…
#> ℹ Calculating total peak abundance outliers at +/- 5 Sdev - excluding 0 sample(…✔ Calculating total peak abundance outliers at +/- 5 Sdev - excluding 0 sample(…
#> ℹ Running sample data PCA outlier analysis at +/- 5 Sdev✔ Running sample data PCA outlier analysis at +/- 5 Sdev [8ms]
#> ℹ Sample PCA outlier analysis - re-identify feature independence and PC outlier…ℹ Sample PCA outlier analysis - re-identify feature independence and PC outlier…                                                                                 ! The stated max PCs [max_num_pcs=10] to use in PCA outlier assessment is greater than the number of available informative PCs [2]
#> ℹ Sample PCA outlier analysis - re-identify feature independence and PC outlier…✔ Sample PCA outlier analysis - re-identify feature independence and PC outlier…
#> ℹ Creating final QC dataset...✔ Creating final QC dataset... [409ms]
#> ℹ Metabolite QC Process Completed✔ Metabolite QC Process Completed [9ms]
```

### View a summary of the Metaboprep object

``` r
# view summary
summary(mydata)
#> 
#> Metaboprep Object Summary
#> --------------------------
#> Samples      : 100
#> Features     : 100
#> Data Layers  : 2
#> Layer Names  : input, qc
#> 
#> Sample Summary Layers : input, qc
#> Feature Summary Layers: input, qc
#> 
#> Sample Annotation (metadata):
#>   Columns: 8
#>   Names  : sample_id, neg, pos, run_day, box_id, lot, reason_excluded, excluded
#> 
#> Feature Annotation (metadata):
#>   Columns: 8
#>   Names  : feature_id, metabolite_id, platform, pathway, kegg, group_hmdb, reason_excluded, excluded
#> 
#> Exclusion Codes Summary:
#> 
#>   Sample Exclusions:
#> Exclusion | Count
#> -----------------
#> user_excluded                     | 0
#> extreme_sample_missingness        | 0
#> user_defined_sample_missingness   | 2
#> user_defined_sample_totalpeakarea | 0
#> user_defined_sample_pca_outlier   | 0
#> 
#>   Feature Exclusions:
#> Exclusion | Count
#> -----------------
#> user_excluded                    | 0
#> extreme_feature_missingness      | 0
#> user_defined_feature_missingness | 0
```

### Plot a dendrogram of the feature tree

``` r
# view feature tree
tree <- attr(mydata@feature_summary, "qc_tree")
par(mar = c(1,3,5,1) )
plot(tree, hang = -1, cex = 0.75, main = "Example Dataset Feature Tree", sub = "", xlab = "")
```

![Dendrogram](reference/figures/README-treeplot-1.png)

# Package index

## Metaboprep Object

The main S7 class behind the metaboprep R package along with class
helper functions. A container for measurement, sample, and feature data.

- [`Metaboprep()`](https://mrcieu.github.io/metaboprep/reference/class_metaboprep.md)
  : Metaboprep Object
- [`summary.Metaboprep`](https://mrcieu.github.io/metaboprep/reference/summary.Metaboprep.md)
  : Summary Method for Metaboprep Object
- [`add_layer()`](https://mrcieu.github.io/metaboprep/reference/add_layer.md)
  : Add a Layer of Data (internal use)

## Importing & Exporting Data

Functions importing data from a variety of data sources and formats.

- [`read_metabolon()`](https://mrcieu.github.io/metaboprep/reference/read_metabolon.md)
  : Read Metabolon Data
- [`read_nightingale()`](https://mrcieu.github.io/metaboprep/reference/read_nightingale.md)
  : Read Nightingale Data (format 1)
- [`read_olink()`](https://mrcieu.github.io/metaboprep/reference/read_olink.md)
  : Read and Process Olink NPX Data File
- [`read_somalogic()`](https://mrcieu.github.io/metaboprep/reference/read_somalogic.md)
  : Read and Process SomaLogic adat file
- [`available_data_formats()`](https://mrcieu.github.io/metaboprep/reference/available_data_formats.md)
  : List Available Data Formats
- [`export()`](https://mrcieu.github.io/metaboprep/reference/export.md)
  : Export Data from a Metaboprep Object
- [`export_comets()`](https://mrcieu.github.io/metaboprep/reference/export_comets.md)
  : Export Data to \`COMETS\` format
- [`export_metaboanalyst()`](https://mrcieu.github.io/metaboprep/reference/export_metaboanalyst.md)
  : Export Data to \`MetaboAnalyst\` format
- [`export_metaboprep()`](https://mrcieu.github.io/metaboprep/reference/export_metaboprep.md)
  : Export Data to \`Metaboprep\` format

## Summary functions

Functions to summarise data.

- [`summarise()`](https://mrcieu.github.io/metaboprep/reference/summarise.md)
  : Summary Statistics
- [`feature_summary()`](https://mrcieu.github.io/metaboprep/reference/feature_summary.md)
  : Feature Summary Statistics
- [`sample_summary()`](https://mrcieu.github.io/metaboprep/reference/sample_summary.md)
  : Sample Summary Statistics
- [`pc_and_outliers()`](https://mrcieu.github.io/metaboprep/reference/pc_and_outliers.md)
  : Principal Component Analysis
- [`tree_and_independent_features()`](https://mrcieu.github.io/metaboprep/reference/tree_and_independent_features.md)
  : Identify Independent Features in a Numeric Matrix

## Quality control & Reporting

Functions to run the quality control pipeline and generate a report.

- [`quality_control()`](https://mrcieu.github.io/metaboprep/reference/quality_control.md)
  : Metabolite Quality Control
- [`available_report_templates()`](https://mrcieu.github.io/metaboprep/reference/available_report_templates.md)
  : List Available Report Templates
- [`generate_report()`](https://mrcieu.github.io/metaboprep/reference/generate_report.md)
  : Generate Output Report
- [`run_metaboprep1()`](https://mrcieu.github.io/metaboprep/reference/run_metaboprep1.md)
  : Metaboprep 1 pipeline
- [`shiny_app()`](https://mrcieu.github.io/metaboprep/reference/shiny_app.md)
  : Metaboprep Shiny App

## Other processing tools

Stand alone data processing or filtering tools.

- [`batch_normalise()`](https://mrcieu.github.io/metaboprep/reference/batch_normalise.md)
  : Batch Normalisation

## Helper functions

Helper functions, mainly used internally.

- [`feature_describe()`](https://mrcieu.github.io/metaboprep/reference/feature_describe.md)
  : Summary Statistics for Features
- [`missingness()`](https://mrcieu.github.io/metaboprep/reference/missingness.md)
  : Estimate Missingness
- [`outlier_detection()`](https://mrcieu.github.io/metaboprep/reference/outlier_detection.md)
  : Identify indexes of outliers in data
- [`outliers()`](https://mrcieu.github.io/metaboprep/reference/outliers.md)
  : Identify Outliers
- [`total_peak_area()`](https://mrcieu.github.io/metaboprep/reference/total_peak_area.md)
  : Estimates total peak abundance
- [`continuous_power_plot()`](https://mrcieu.github.io/metaboprep/reference/continuous_power_plot.md)
  : continuous trait power analysis plot
- [`multivariate_anova()`](https://mrcieu.github.io/metaboprep/reference/multivariate_anova.md)
  : multivariate analysis
- [`cramerV()`](https://mrcieu.github.io/metaboprep/reference/cramerV.md)
  : Cramer's V (phi)
- [`eval.power.binary.imbalanced()`](https://mrcieu.github.io/metaboprep/reference/eval.power.binary.imbalanced.md)
  : Estimate power for a binary variable in an imbalanced design
- [`eval.power.cont()`](https://mrcieu.github.io/metaboprep/reference/eval.power.cont.md)
  : estimate power for continuous variable
- [`find.PA.effect.sizes.2.sim()`](https://mrcieu.github.io/metaboprep/reference/find.PA.effect.sizes.2.sim.md)
  : identify effect sizes
- [`find.cont.effect.sizes.2.sim()`](https://mrcieu.github.io/metaboprep/reference/find.cont.effect.sizes.2.sim.md)
  : identify continuos trait effect sizes
- [`imbalanced_power_plot()`](https://mrcieu.github.io/metaboprep/reference/imbalanced_power_plot.md)
  : binary trait imbalanced design power analysis plot
- [`variable_by_factor()`](https://mrcieu.github.io/metaboprep/reference/variable_by_factor.md)
  : ggplot2 violin plot
- [`clean_names()`](https://mrcieu.github.io/metaboprep/reference/clean_names.md)
  : Standardize Column or Feature Names

# Articles

### All vignettes

- [Batch
  Normalise](https://mrcieu.github.io/metaboprep/articles/batch_normalise.md):
- [Export Data](https://mrcieu.github.io/metaboprep/articles/export.md):
- [Feature
  summary](https://mrcieu.github.io/metaboprep/articles/feature_summary.md):
- [Generate QC
  Report](https://mrcieu.github.io/metaboprep/articles/generate_report.md):
- [Import Metabolon Metabolomic
  Data](https://mrcieu.github.io/metaboprep/articles/metabolon.md):
- [Import Nightingale Metabolomic
  Data](https://mrcieu.github.io/metaboprep/articles/nightingale.md):
- [Import Olink Proteomic
  Data](https://mrcieu.github.io/metaboprep/articles/olink.md):
- [quality_control](https://mrcieu.github.io/metaboprep/articles/quality_control.md):
- [Sample
  summary](https://mrcieu.github.io/metaboprep/articles/sample_summary.md):
- [Import Somalogic Proteomic
  Data](https://mrcieu.github.io/metaboprep/articles/somalogic.md):
